on:
  push:
    branches: [master]
  pull_request:

name: docs

jobs:
  docs:
    runs-on: ubuntu-latest
    name: build
    container:
      image: ghcr.io/gtk-rs/gtk-rs/gtk:latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: nightly
          override: true
      - working-directory: gir
        run: cargo build --release
      - run: rustup component add rustfmt
      - run: cargo install rustdoc-stripper
      - run: python3 ./generator.py --embed-docs --yes ./
      - uses: actions-rs/cargo@v1
        with:
          command: doc
          args: -p atk -p atk-sys -p cairo-rs -p cairo-sys-rs -p gdk -p gdk-sys -p gdk-pixbuf -p gdk-pixbuf-sys -p gdkx11 -p gdkx11-sys -p gio -p gio-sys -p glib -p gobject-sys -p glib-sys -p glib-macros -p graphene-rs -p graphene-sys -p gtk -p gtk3-macros -p gtk-sys -p pango -p pango-sys -p pangocairo -p pangocairo-sys --features dox --no-deps
        env:
          RUSTDOCFLAGS: "--enable-index-page -Zunstable-options"

      - name: deploy
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target/doc/
          keep_files: false
          destination_dir: git/docs
